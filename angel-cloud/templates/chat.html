{% extends "base.html" %}
{% block title %}Chat â€” Angel Cloud{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-messages" id="messages">
        <div class="msg-assistant">Hey {{ user.username }}. What's on your mind?</div>
    </div>
    <div class="chat-input-bar">
        <input type="text" id="chat-input" placeholder="Talk to ShaneBrain..." autocomplete="off">
        <button id="send-btn">SEND</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const input = document.getElementById('chat-input');
    const btn = document.getElementById('send-btn');
    const messages = document.getElementById('messages');
    let sending = false;

    function addMessage(text, cls) {
        const div = document.createElement('div');
        div.className = cls;
        div.textContent = text;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
        return div;
    }

    async function send() {
        const text = input.value.trim();
        if (!text || sending) return;

        sending = true;
        btn.disabled = true;
        input.value = '';

        addMessage(text, 'msg-user');

        // Create assistant bubble that we'll stream into
        const bubble = document.createElement('div');
        bubble.className = 'msg-assistant';
        bubble.textContent = '';
        messages.appendChild(bubble);
        messages.scrollTop = messages.scrollHeight;

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: text})
            });

            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let buf = '';

            while (true) {
                const {done, value} = await reader.read();
                if (done) break;
                buf += decoder.decode(value, {stream: true});

                let lines = buf.split('\n');
                buf = lines.pop();

                for (const line of lines) {
                    if (!line.startsWith('data: ')) continue;
                    const data = JSON.parse(line.slice(6));
                    if (data.token) {
                        bubble.textContent += data.token;
                        messages.scrollTop = messages.scrollHeight;
                    }
                    if (data.done && data.level_up) {
                        addMessage('LEVEL UP: ' + data.new_level + '!', 'level-up-banner');
                    }
                }
            }

            if (!bubble.textContent) {
                bubble.textContent = 'No response received.';
            }
        } catch (e) {
            bubble.textContent = 'Connection error. Try again.';
        }

        sending = false;
        btn.disabled = false;
        input.focus();
    }

    btn.addEventListener('click', send);
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') send();
    });
    input.focus();
})();
</script>
{% endblock %}
