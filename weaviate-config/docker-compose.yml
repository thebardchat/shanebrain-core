# =============================================================================
# ShaneBrain Core - Weaviate Docker Compose Configuration
# =============================================================================
#
# LEAN VERSION - Uses Ollama for embeddings (no RAM-hungry transformers)
#
# Usage:
#   cd weaviate-config
#   docker-compose up -d              # Start Weaviate
#   docker-compose down               # Stop
#   docker-compose logs -f weaviate   # View logs
#
# =============================================================================

services:
  # ===========================================================================
  # Weaviate Vector Database (ONLY container needed)
  # ===========================================================================
  weaviate:
    image: semitechnologies/weaviate:1.28.0
    container_name: shanebrain-weaviate
    restart: unless-stopped
    ports:
      - "8080:8080"      # REST API
      - "50051:50051"    # gRPC
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./data:/var/lib/weaviate
      - ./backups:/var/lib/weaviate/backups
    environment:
      # =======================================================================
      # Core Configuration
      # =======================================================================
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      CLUSTER_HOSTNAME: 'node1'

      # =======================================================================
      # Module Configuration - LEAN (Ollama-based)
      # =======================================================================
      DEFAULT_VECTORIZER_MODULE: 'text2vec-ollama'
      ENABLE_MODULES: 'text2vec-ollama,generative-ollama,backup-filesystem'

      # Ollama connection (host = Pi running Ollama natively)
      OLLAMA_API_ENDPOINT: 'http://host.docker.internal:11434'

      # Backup settings
      BACKUP_FILESYSTEM_PATH: '/var/lib/weaviate/backups'

      # =======================================================================
      # Performance - Tuned for 7.4GB RAM
      # =======================================================================
      LIMIT_RESOURCES: 'false'
      GOMAXPROCS: '2'
      GOMEMLIMIT: '1GiB'

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/v1/.well-known/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    networks:
      - shanebrain-network

  # ===========================================================================
  # ShaneBrain MCP Server â€” exposes all tools via Model Context Protocol
  # ===========================================================================
  mcp-server:
    build:
      context: ..
      dockerfile: mcp-server/Dockerfile
    container_name: shanebrain-mcp
    restart: unless-stopped
    ports:
      - "8100:8100"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      WEAVIATE_HOST: shanebrain-weaviate
      WEAVIATE_PORT: "8080"
      WEAVIATE_GRPC_PORT: "50051"
      OLLAMA_HOST: "http://host.docker.internal:11434"
    depends_on:
      weaviate:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 512M
    networks:
      - shanebrain-network

# =============================================================================
# Networks
# =============================================================================
networks:
  shanebrain-network:
    driver: bridge
    name: shanebrain-network